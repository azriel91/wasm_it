<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>WASM It</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="mermaid/mermaid.css">
        
        <link rel="stylesheet" href="mermaid/additional.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="vision.html"><strong aria-hidden="true">2.</strong> Vision</a></li><li class="chapter-item expanded "><a href="wasm.html"><strong aria-hidden="true">3.</strong> WASM</a></li><li class="chapter-item expanded "><a href="runtime_environment.html"><strong aria-hidden="true">4.</strong> Runtime Environment</a></li><li class="chapter-item expanded "><a href="application_concepts.html"><strong aria-hidden="true">5.</strong> Application Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="application_concepts/event_loop.html"><strong aria-hidden="true">5.1.</strong> Event Loop</a></li><li class="chapter-item expanded "><a href="application_concepts/multithreading.html"><strong aria-hidden="true">5.2.</strong> Multithreading</a></li><li class="chapter-item expanded "><a href="application_concepts/configuration.html"><strong aria-hidden="true">5.3.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="application_concepts/rendering.html"><strong aria-hidden="true">5.4.</strong> Rendering</a></li><li class="chapter-item expanded "><a href="application_concepts/audio.html"><strong aria-hidden="true">5.5.</strong> Audio</a></li><li class="chapter-item expanded "><a href="application_concepts/networking.html"><strong aria-hidden="true">5.6.</strong> Networking</a></li></ol></li><li class="chapter-item expanded "><a href="demo.html"><strong aria-hidden="true">6.</strong> Demo</a></li><li class="chapter-item expanded "><a href="worth_mentioning.html"><strong aria-hidden="true">7.</strong> Worth Mentioning</a></li><li class="chapter-item expanded "><a href="links.html"><strong aria-hidden="true">8.</strong> Links</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">WASM It</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#introduction" id="introduction">Introduction</a></h1>
<p>Adding WASM support to an existing native application is unchartered waters for many projects.</p>
<p>This talk covers the conceptual differences between native and WASM application execution, and illustrates the problems encountered and how they were solved.</p>
<p>It does <em>not</em> provide exact detail on the code changes that were made. That detail will be provided in a <code>wasm_rush_report</code> book that will be released within the next week.</p>
<p>This is also <em>not</em> a talk on how WASM works or how to write WASM, but Utah Rust published their <a href="https://users.rust-lang.org/t/webassembly-wat-and-rust-video-presentation/41784">WASM introduction videos</a> which cover this.</p>
<hr style="width: 95%; border: 1px solid #ccc;" />
<p>Written for the Rust Auckland meetup 2020-05-04.</p>
<ul>
<li>Rust Auckland meetup: <a href="https://www.meetup.com/rust-akl/">https://www.meetup.com/rust-akl/</a></li>
<li>Slack: <a href="https://rust-akl.slack.com/messages/CCC7KUXMY/">https://rust-akl.slack.com/messages/CCC7KUXMY/</a></li>
<li>Repository: <a href="https://github.com/azriel91/wasm_it">https://github.com/azriel91/wasm_it</a></li>
</ul>
<p>Feel free to use and improve on these.</p>
<h1><a class="header" href="#vision" id="vision">Vision</a></h1>
<p>Given a native application, make it work in the browser:</p>
<p><a href="will_native.png"><img src="will_native.png" width="320" height="240" />
</a> <a href="will_browser_vision.png"><img src="will_browser_vision.png" width="320" height="240" />
</a></p>
<h1><a class="header" href="#wasm" id="wasm">WASM</a></h1>
<h2><a class="header" href="#what-is-wasm" id="what-is-wasm">What is WASM</a></h2>
<blockquote>
<p>&quot;Very very fast JavaScript&quot;</p>
</blockquote>
<p>Web assembly is low level bytecode that runs in the browser. For more detail, visit the <a href="https://webassembly.org/">Web Assembly</a> website, and watch the <a href="https://users.rust-lang.org/t/webassembly-wat-and-rust-video-presentation/41784">WASM introduction videos</a> from the Utah Rust meetup.</p>
<h2><a class="header" href="#why-wasm" id="why-wasm">Why WASM</a></h2>
<ul>
<li>Cross-platform – cross OS, device.</li>
<li>Sandboxed environment (security – file system, memory).</li>
<li>Many <a href="https://github.com/appcypher/awesome-wasm-langs">programming languages</a> compile to WASM.</li>
<li>Many other <a href="https://webassembly.org/docs/use-cases/">use cases</a>.</li>
</ul>
<h1><a class="header" href="#runtime-environment" id="runtime-environment">Runtime Environment</a></h1>
<p>There are some differences between native and browser environments.</p>
<table><thead><tr><th>Item</th><th>Native</th><th>Browser / WASM</th></tr></thead><tbody>
<tr><td>Access to shared libraries</td><td>✅</td><td>❌</td></tr>
<tr><td>Access to file system</td><td>✅</td><td>❌</td></tr>
<tr><td>Memory</td><td><code>unlimited</code></td><td><a href="https://github.com/WebAssembly/design/blob/master/FutureFeatures.md#linear-memory-bigger-than-4-gib">4 GB</a><sup>1</sup></td></tr>
<tr><td></td><td></td><td></td></tr>
<tr><td>Networking</td><td>Any TCP, UDP</td><td>XHR, Web Sockets, QUIC</td></tr>
<tr><td>Threading</td><td>OS threads</td><td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API">Web Workers</a></td></tr>
</tbody></table>
<p><strong>Notes:</strong></p>
<p><sup>1</sup> 2 GB on Chrome – V8 JS implementation specific limit.</p>
<h1><a class="header" href="#subject-areas" id="subject-areas">Subject Areas</a></h1>
<blockquote>
<p><strong>Amethyst:</strong> Data-driven game engine written in Rust</p>
<p><a href="https://amethyst.rs/">https://amethyst.rs/</a></p>
</blockquote>
<p>As a native game engine library, functionality provided by Amethyst span the following subject areas:</p>
<ul>
<li>Event loop</li>
<li>Multithreading</li>
<li>Configuration</li>
<li>Rendering</li>
<li>Audio</li>
<li>Networking</li>
</ul>
<p>The pages in this section cover the conceptual differences at runtime, that are relevant to decisions made at development time.</p>
<h1><a class="header" href="#event-loop" id="event-loop">Event Loop</a></h1>
<p>Takeaways:</p>
<ul>
<li>An event loop is a loop that polls for an event.</li>
<li>When an event is received, some code is run. The code is the <code>event_handler</code>.</li>
<li>The application provides the <code>event_handler</code>.</li>
<li><strong>Native:</strong> The application controls the event loop – <code>winit</code>.</li>
<li><strong>WASM:</strong> The browser controls the event loop, but consistent API is still exposed by <code>winit</code>.</li>
</ul>
<details>
<summary>Event loop example</summary>
<span style="display: block; margin-left: 20px;">
<p><code>winit</code>:</p>
<pre><code class="language-rust ignore">// Not real code
impl EventLoop {
    pub fn run&lt;F&gt;(self, event_handler: F) -&gt; !
    where
        F: ..
    {
        loop {
            let event = poll_event(); // Blocks until an event arrives.
            event_handler(event, ..);
        }
    }
}
</code></pre>
<p><code>amethyst</code>:</p>
<pre><code class="language-rust ignore">// Not real code, but close 🤏.
let event_handler = move |event, _, control_flow| {
    match event {
        // tick the game
        Event::MainEventsCleared =&gt; self.run_game_logic(),

        // input
        Event::DeviceEvent(device_event) =&gt; self.notify_input(device_event),
        _ =&gt; {},
    }
};

event_loop.run(event_handler);

// Never reached, as EventLoop::run(_) returns `!`.
</code></pre>
</span>
</details>
<pre><code class="language-rust ignore">loop {
    let event = poll_event(); // Blocks until an event arrives.
    event_handler(event, ..);
}
</code></pre>
<h2><a class="header" href="#native" id="native">Native</a></h2>
<p>In a native application, the event loop receives events from the operating system.</p>
<h2><a class="header" href="#wasm-1" id="wasm-1">WASM</a></h2>
<p>In a browser, the event loop is not controlled by <code>winit</code>, but the <em>browser</em>.</p>
<p>To surrender control to the browser, <code>winit</code> sends the event handler to the browser, and <a href="https://github.com/rust-windowing/winit/blob/v0.22.0/src/platform_impl/web/event_loop/mod.rs#L38-L59">panics</a>.</p>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame"><code>Window::requestAnimationFrame</code></a> API is used to receive events.</p>
<details open>
<summary>Javascript callback example</summary>
<span style="display: block; margin-left: 20px;">
<pre><code class="language-js">// While `pixel_shift`` is less than 100, call `requestAnimationFrame`.
var pixel_shift = 0;

function move(_timestamp) {
  element.style.transform = 'translateX(' + pixel_shift + 'px)';

  if (pixel_shift &lt; 100) {
    pixel_shift += 1;
    window.requestAnimationFrame(move);
  }
}

window.requestAnimationFrame(move);
</code></pre>
</span>
</details>
<p>To ensure <code>requestAnimationFrame</code> is called, in the event handler, the <code>control_flow</code> parameter must be set to <code>ControlFlow::Poll</code>.</p>
<pre><code class="language-rust ignore">let event_handler = move |event, _, control_flow| {
    // ..

    // Ensure the browser calls `requestAnimationFrame`
    // This will ensure this event handler is run, even if no events arrive.
    *control_flow = ControlFlow::Poll;
};

event_loop.run(event_handler);
</code></pre>
<h1><a class="header" href="#multithreading" id="multithreading">Multithreading</a></h1>
<p>Takeaways:</p>
<ul>
<li>Performance can be achieved by parallelizing tasks.</li>
<li><strong>Native:</strong> Tasks submitted to the thread pool are executed immediately<sup>[citation needed]</sup>.</li>
<li><strong>WASM:</strong> Tasks submitted to the thread pool are <a href="https://github.com/azriel91/worker_sync_xhr">executed when control returns to the browser</a>.</li>
<li><strong>WASM:</strong> Since tasks will never run until the main thread returns, the main thread cannot wait for tasks to complete.</li>
<li>Github issue(s): <a href="https://github.com/amethyst/amethyst/issues/2191">amethyst#2191</a></li>
</ul>
<p>Amethyst uses <code>rayon</code> to manage a thread pool, and parallel processing is achieved by submitting tasks to that pool.</p>
<details>
<summary>Dispatcher</summary>
<span style="display: block; margin-left: 20px;">
<p><img src="application_concepts/multithreading_dispatcher_0.generated.svg" alt="" title="Dispatcher" /></p>
</span>
</details>
<h2><a class="header" href="#native-1" id="native-1">Native</a></h2>
<p>In native applications, parallel execution is enabled by default.</p>
<p>When tasks are submitted to the thread pool, they are executed immediately.</p>
<details open>
<summary>Parallel execution control flow</summary>
<span style="display: block; margin-left: 20px;">
<!-- Hide placeholder node -->
<style>
#actor1 + rect.actor { display: none; }
pre.mermaid > svg > g:nth-last-of-type(4) { display: none; }
</style>
<p><span style="display:none;"> </span> <!-- Needed to get the diagram to show up within the details block --></p>
<pre class="mermaid">sequenceDiagram
    participant main
    participant #nbsp;
    participant W0
    participant W1
    participant W2

    main ->>+ #nbsp;: dispatch_par()

    rect rgba(0, 100, 255, .2)
        #nbsp; -->>+ W2: 🎶 Play Music#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;

        #nbsp; -->>+ W0: 🎮 Device#nbsp;#nbsp;#nbsp;#nbsp;
        #nbsp; -->>+ W1: 🌐 Network #nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;

        W0 -->>- #nbsp;: #nbsp;
        W1 -->>- #nbsp;: #nbsp;

        W2 -->>- #nbsp;: #nbsp;

        #nbsp; -->>+ W2: 📦 Load Assets#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;
        Note left of W2: 📦 Task

        #nbsp; -->>+ W1: 📄 Read File#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;#nbsp;

        W2 -->>- #nbsp;: #nbsp;
        W1 -->>- #nbsp;: #nbsp;

        #nbsp; -->>+ W0: 📡 Position#nbsp;#nbsp;#nbsp;
        W0 -->>- #nbsp;: #nbsp;

        W1 -->+ W1: 📦 Asset Load Task

    end

    #nbsp; ->>- main: #nbsp;


    %% Asset Load Task end
    W1 -->- W1: #nbsp;

    main ->>+ #nbsp;: dispatch_thread_local()

    rect rgba(180, 0, 220, .2)
        #nbsp; -->>+ main: 🖌️ Render
        main -->>- #nbsp;: #nbsp;
        #nbsp; -->>+ main: 🎨 Load Textures
        main -->>- #nbsp;: #nbsp;
    end

    #nbsp; ->>- main: #nbsp;
</pre>
</span>
</details>
<h2><a class="header" href="#wasm-2" id="wasm-2">WASM</a></h2>
<p>When adding WASM support, sequential execution is used.</p>
<p>If we tried to use parallel execution, tasks that are submitted to the thread pool are queued. They will only run when control has been returned to the browser, as the browser will only send the tasks (as messages) to each web worker when it has control. This is a problem because the main thread would be waiting for all the tasks to complete, when in fact nothing is running.</p>
<details open>
<summary>Sequential execution control flow</summary>
<span style="display: block; margin-left: 20px;">
<!-- Hide placeholder node -->
<style>
#actor6 + rect.actor { display: none; }
</style>
<p><span style="display:none;"> </span> <!-- Needed to get the diagram to show up within the details block --></p>
<pre class="mermaid">sequenceDiagram
    participant main
    participant #nbsp;
    participant W0;
    participant W1;
    participant W2;

    main ->>+ #nbsp;: dispatch_seq()

    rect rgba(0, 100, 255, .2)
        #nbsp; -->>+ main: 🎮 Device
        main -->>- #nbsp;: #nbsp;

        #nbsp; -->>+ main: 🌐 Network
        main -->>- #nbsp;: #nbsp;

        #nbsp; -->>+ main: 📦 Load Assets
        Note left of #nbsp;: 📦 Task
        main -->>- #nbsp;: #nbsp;

        #nbsp; -->>+ main: 📄 Read File
        main -->>- #nbsp;: #nbsp;

        #nbsp; -->>+ main: 📡 Position
        main -->>- #nbsp;: #nbsp;

        #nbsp; -->>+ main: 🎶 Play Music
        main -->>- #nbsp;: #nbsp;
    end

    #nbsp; ->>- main: #nbsp;

    main ->>+ #nbsp;: dispatch_thread_local()

    rect rgba(180, 0, 220, .2)
        #nbsp; -->>+ main: 🖌️ Render
        main -->>- #nbsp;: #nbsp;
        #nbsp; -->>+ main: 🎨 Load Textures
        main -->>- #nbsp;: #nbsp;
    end

    #nbsp; ->>- main: #nbsp;

    W0 -->+ W0: 📦 Asset Load Task

    %% Asset Load Task end
    W0 -->- W0: #nbsp;
</pre>
</span>
</details>
<h1><a class="header" href="#configuration" id="configuration">Configuration</a></h1>
<p>Takeaways:</p>
<ul>
<li><strong>Native:</strong> Configuration is read from environment variables, command line, and the file system.</li>
<li><strong>WASM:</strong> Configuration has to be loaded externally – query parameters, HTML form, XHR.</li>
<li>Github issue(s): <a href="https://github.com/amethyst/amethyst/issues/2180">amethyst#2180</a>, <a href="https://github.com/amethyst/amethyst/issues/2214">amethyst#2214</a></li>
</ul>
<h2><a class="header" href="#native-2" id="native-2">Native</a></h2>
<p>Native applications read from several kinds of configuration:</p>
<details open>
<summary><b>Command line arguments:</b> Online play server address</summary>
<span style="display: block; margin-left: 20px;">
<pre><code class="language-bash">cargo run --bin will --release -- --session_server_address 127.0.0.1
</code></pre>
</span>
</details>
<details open>
<summary><b>Configuration files:</b> Input settings, log levels</summary>
<span style="display: block; margin-left: 20px;">
<pre><code class="language-yaml">--- logger.yaml
stdout: &quot;Colored&quot; # &quot;Off&quot;, &quot;Plain&quot;, &quot;Colored&quot;
level_filter: &quot;debug&quot;
module_levels:
  - [&quot;amethyst&quot;, &quot;warn&quot;]
  - [&quot;net_play&quot;, &quot;info&quot;]
  - [&quot;session_server&quot;, &quot;info&quot;]
</code></pre>
</span>
</details>
<details open>
<summary><b>Assets:</b> UI configuration, images &ndash; sprite sheets</summary>
<span style="display: block; margin-left: 20px;">
<p><img src="application_concepts/./configuration_rox.png" alt="Character Sprite Sheet" /></p>
</span>
</details>
<h2><a class="header" href="#wasm-3" id="wasm-3">WASM</a></h2>
<p>WASM applications don't have access to those forms of input, but can use others:</p>
<style>
input[type="text"] {
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 14px;
    line-height: 1.6em;
}

input[type="text"]:focus {
    box-shadow: 0px 0px 2px 1px #aaccff;
}

button {
    background: #f0f0f0;
    border-left-width: 1px;
    border-top-width: 1px;
    border-right-width: 1px;
    border-bottom-width: 1px;
    border-radius: 3px;
    border-style: solid;
    border-color: #ccc;
    padding-left: 24px;
    padding-top: 4px;
    padding-right: 24px;
    padding-bottom: 4px;
}

button:hover {
    background: #f8f8f8;
}

button:hover:active {
    background: #eeeeee;
    box-shadow: 0px 0px 2px 1px #aaccff;
}
</style>
<p>
<details open>
<summary><b>Query Parameters:</b></summary>
<div style="display: block; margin-left: 20px;">
<pre><code class="language-text">http://localhost:8000/?session_server_address=127.0.0.1
</code></pre>
</div>
</details>
</p>
<p>
<details open>
<summary><b>Forms:</b></summary>
<p>
<div style="
    display: inline-block;
    margin-left: 20px;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
    padding: 5px 30px;
    font-size: 14px;
">
<div style="text-align: center;"><img src="application_concepts/configuration_will.png" width="150" height="100" /></div>
<form method="post">
<p><label for="session_server_address" name="session_server_address" style="display: inline-block; width: 125px;">Server Address:</label> <input type="text" name="session_server_address" value = "127.0.0.1" /></p>
<p><label for="session_server_port" name="session_server_port" style="display: inline-block; width: 125px;">Server Port:</label> <input type="text" name="session_server_port" value = "1234" /></p>
<div style="text-align: center;"><p><button type="submit" name="game_start" onclick="window.open('https://azriel.im/pong_wasm', '_blank', 'innerWidth=800,innerHeight=601');">Play</button></p></div>
</form>
</div>
</p>
</details>
</p>
<p>
<details open>
<summary><b>XML HTTP Requests:</b></summary>
<span style="display: block; margin-left: 20px;">
<ul>
<li>
<p>On the application's web page:</p>
<pre><code class="language-js">let logger_config = await fetch('app/will/logger.yaml')
    .then((response) =&gt; { return response.text(); });

wasm_bindgen.WillAppBuilder
    .new()
    .with_logger_config(logger_config)
    .run();
</code></pre>
</li>
<li>
<p>Within the application:</p>
<pre><code class="language-rust ignore">let xhr = XmlHttpRequest::new()?;
xhr.open_with_async(&quot;GET&quot;, path_str, false)?;
xhr.send()?;
let response = xhr.response()?;
</code></pre>
<p>See <a href="https://github.com/amethyst/amethyst/blob/74fd3e2/amethyst_assets/src/source/http.rs"><code>HttpSource</code></a>.</p>
</li>
<li>
<p>Simulated file system accesses using XHRs:</p>
<pre><code class="language-rust ignore">#[cfg(not(target_arch = &quot;wasm32&quot;))]
let background_definition_path_exists = background_definition_path.exists();
#[cfg(target_arch = &quot;wasm32&quot;)]
let background_definition_path_exists =
    background_definition_path.exists_on_server();
</code></pre>
<p>See <a href="https://github.com/azriel91/autexousious/blob/0.19.0/crate/wasm_support_fs/src/path_access_ext.rs"><code>PathAccessExt</code></a> – caches <code>file.exists()</code> values from the server.</p>
</li>
</ul>
</span>
</details>
</p>
<h1><a class="header" href="#rendering" id="rendering">Rendering</a></h1>
<p>Takeaways:</p>
<ul>
<li>The output variables of one shader are used as the input variables to the next shader.</li>
<li><strong>Native:</strong> The <em>types</em> of the variables passed from one shader to the next shader need to match.</li>
<li><strong>WASM:</strong> The <em>names and types</em> of the variables passed from one shader to the next shader need to match.</li>
<li>Github issue(s): <a href="https://github.com/amethyst/amethyst/issues/2192">amethyst#2192</a>, <a href="https://github.com/amethyst/amethyst/issues/2205">amethyst#2205</a>, <a href="https://github.com/amethyst/amethyst/issues/2247">amethyst#2247</a></li>
</ul>
<p>In Amethyst, rendering is done with a standard graphics pipeline. <em>Shaders</em> are little programs along the pipeline that transform data to be drawn on screen.</p>
<p><img src="application_concepts/rendering_graphics_pipeline_0.generated.svg" alt="" title="Graphics Pipeline" /></p>
<p>A shader looks like this:</p>
<pre><code class="language-c">#version 450

// some details removed

// input parameters
in vec2 var_in_0;
in vec2 var_in_1;

// output parameters
out vec2 var_0;
out vec4 var_1;

void main() {
    // code
}
</code></pre>
<h2><a class="header" href="#native-3" id="native-3">Native</a></h2>
<p>The types of the output variables from one shader need to match the types of the input variables of the next shader:</p>
<ul>
<li>
<p>✂️ Vertex shader</p>
<pre><code class="language-c">out vec2 tex_coords;
out vec4 color;
</code></pre>
</li>
<li>
<p>🖍️ Fragment shader</p>
<pre><code class="language-c">// Variable types match up.
in vec2 in_tex_coords;
in vec4 in_color;
</code></pre>
</li>
</ul>
<h2><a class="header" href="#wasm-4" id="wasm-4">WASM</a></h2>
<p>The names and types of the output variables from one shader need to match the names and types of the input variables of the next shader:</p>
<ul>
<li>
<p>✂️ Vertex shader</p>
<pre><code class="language-c">out vec2 vert_out_tex_coords;
out vec4 vert_out_color;
</code></pre>
</li>
<li>
<p>🖍️ Fragment shader</p>
<pre><code class="language-c">// Variable names and types match up.
in vec2 vert_out_tex_coords;
in vec4 vert_out_color;
</code></pre>
</li>
</ul>
<h1><a class="header" href="#audio" id="audio">Audio</a></h1>
<p>Takeaways:</p>
<ul>
<li>Any memory accessed by Web Workers is in the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer"><code>SharedArrayBuffer</code></a>.</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBuffer/copyToChannel"><code>AudioBuffer::copyToChannel</code></a> must be given <em>owned</em> memory.</li>
<li>Cloning the memory – whether in Rust or JS – then calling <code>audio_buffer.copy_to_channel</code> in Rust still goes through a <code>SharedArrayBuffer</code>.</li>
<li>Workaround: pass both the <code>AudioBuffer</code> and the bytes to JS, clone the memory, then call <code>audioBuffer.copyToChannel</code> in JS.</li>
<li><strong>WASM:</strong> The user needs to interact with the page for audio to play.</li>
<li>Github issue(s): <a href="https://github.com/amethyst/amethyst/issues/2195">amethyst#2195</a></li>
</ul>
<h2><a class="header" href="#native-4" id="native-4">Native</a></h2>
<ol>
<li>🎵 You want to play music.</li>
<li>🎶 You send music to the audio buffer.</li>
<li>🔊 Music plays.</li>
</ol>
<h2><a class="header" href="#wasm-5" id="wasm-5">WASM</a></h2>
<ol>
<li>
<p>🎵 You want to play music.</p>
</li>
<li>
<p>📜 You change your build script so <code>Worker</code>s can be initialized without a browser <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioContext"><code>AudioContext</code></a>.</p>
<pre><code class="language-js">// Before
const lAudioContext = (
    typeof AudioContext !== 'undefined' ?
    AudioContext :
    webkitAudioContext
);

// After
const lAudioContext = (
    typeof AudioContext !== 'undefined' ?
    AudioContext :
        typeof webkitAudioContext !== 'undefined' ?
        webkitAudioContext :
        null
);
</code></pre>
</li>
<li>
<p>📨 You send the <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBuffer"><code>AudioBuffer</code></a> and the audio byte array (accessed through <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer"><code>SharedArrayBuffer</code></a>) to JS.</p>
<pre><code class="language-rust ignore">#[wasm_bindgen]
extern &quot;C&quot; {
    fn copy_audio_buffer(dest: &amp;AudioBuffer, src: &amp;[f32], channel: i32);
}
</code></pre>
</li>
<li>
<p>📋 You clone the data.</p>
<p>There are 5 ways to &quot;copy&quot; data. Only one truely clones:</p>
<pre><code class="language-js">function make_standalone(src) {
    // These don't clone the data.
    var standalone = Float32Array.from(src);
    var standalone = new Float32Array(src);
    var standalone = src.slice();
    var standalone = ArrayBuffer.transfer(src);

    // This one does.
    var standalone = [...src];

    return standalone;
}
</code></pre>
</li>
<li>
<p>🎶 You send music to the audio buffer.</p>
<pre><code class="language-js">function copy_audio_buffer(dest, src, channel) {
    // Turn the array view into owned memory.
    var standalone = [...src];
    // Make it a Float32Array.
    var buffer = new Float32Array(standalone);

    // Copy the data.
    dest.copyToChannel(buffer, channel);
}
</code></pre>
</li>
<li>
<p>🔇 Nothing plays, because you need a user interaction.</p>
</li>
<li>
<p>🖱️ You make the user click the canvas.</p>
</li>
<li>
<p>🔊 Music plays.. ..when the main thread returns.</p>
</li>
</ol>
<h1><a class="header" href="#networking" id="networking">Networking</a></h1>
<p>Takeaways:</p>
<ul>
<li><strong>Native:</strong> Arbitrary TCP, UDP connections can be made.</li>
<li><strong>Native:</strong> Can communicate using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API"><code>WebSocket</code></a> protocol.</li>
<li><strong>WASM:</strong> Need to obey browser security rules.</li>
<li><strong>WASM:</strong> Can communicate using <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API"><code>WebSocket</code></a>s.</li>
<li><strong>WASM:</strong> Receiving messages is done through callbacks, and requires a lot of wiring to pass the message back to Rust.</li>
<li>Github issue(s): <a href="https://github.com/amethyst/amethyst/issues/2251">amethyst#2251</a></li>
</ul>
<h2><a class="header" href="#native-5" id="native-5">Native</a></h2>
<h3><a class="header" href="#sending-messages" id="sending-messages">Sending Messages</a></h3>
<ol>
<li>🌐 You want to play online.</li>
<li>🔌 You open a connection.</li>
<li>📡 You send data.</li>
</ol>
<h3><a class="header" href="#receiving-messages" id="receiving-messages">Receiving Messages</a></h3>
<ol>
<li>Check for messages received by the network socket.</li>
<li>Iterate and decide what to do with them.</li>
</ol>
<h2><a class="header" href="#wasm-6" id="wasm-6">WASM</a></h2>
<p><strong>Note:</strong> If you retain the TCP / UDP code, the WASM application doesn't crash, but simply logs that this part is not implemented.</p>
<h3><a class="header" href="#sending-messages-1" id="sending-messages-1">Sending Messages</a></h3>
<ol>
<li>
<p>🌐 You want to play online.</p>
</li>
<li>
<p>📨 You send the <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API"><code>WebSocket</code></a> and the message byte array (accessed through <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer"><code>SharedArrayBuffer</code></a>) to JS.</p>
<pre><code class="language-rust ignore">#[wasm_bindgen]
extern &quot;C&quot; {
    fn web_socket_send(web_socket: &amp;WebSocket, src: &amp;[u8]);
}
</code></pre>
</li>
<li>
<p>📋 You clone the data.</p>
</li>
<li>
<p>💽 You send data to the web socket.</p>
<pre><code class="language-js">function web_socket_send(web_socket, src) {
    // Turn the array view into owned memory.
    var standalone = [...src];
    // Make it a Uint8Array.
    let bytes = new Uint8Array(standalone);

    web_socket.send(bytes);
}
</code></pre>
</li>
<li>
<p>📮 The message is sent when the main thread returns.</p>
</li>
</ol>
<h3><a class="header" href="#receiving-messages-1" id="receiving-messages-1">Receiving Messages</a></h3>
<ol>
<li>When creating the web socket, set up an <code>onmessage</code> callback.</li>
<li>In the <code>onmessage</code> callback, use a [<code>FileReader</code>] to begin to read the bytes from the socket.</li>
<li>Also, set up an <code>onload</code> callback for when the <code>FileReader</code> has finished reading bytes.</li>
<li>In the <code>onload</code> callback, send the message through to Rust using a <code>channel</code>.</li>
<li>In Rust, read from the channel for any messages.</li>
</ol>
<h1><a class="header" href="#demo" id="demo">Demo</a></h1>
<p><strong>Left:</strong> vision, <strong>Right:</strong> actual</p>
<p><a href="will_browser_vision.png"><img src="will_browser_vision.png" width="320" height="240" />
</a> <a href="will_browser.png"><img src="will_browser.png" width="320" height="240" />
</a></p>
<p>It's very nice when something turns out to be how it was envisioned in the first place.</p>
<h2><a class="header" href="#live" id="live">Live</a></h2>
<ol>
<li>
<p>Run both native and web versions</p>
<pre><code class="language-bash">cd autexousious # https://github.com/azriel91/autexousious

# native
cargo run --bin will --release -- --session_server_address 127.0.0.1

# web
./scripts/build_wasm.sh
simple-http-server -i --nocache
</code></pre>
</li>
<li>
<p>For online play, run the session server:</p>
<pre><code class="language-bash">cargo run --bin session_server --release -- --address 127.0.0.1
</code></pre>
</li>
<li>
<p>Open <a href="http://localhost:8000">http://localhost:8000</a> in Chrome.</p>
</li>
</ol>
<h2><a class="header" href="#video" id="video">Video</a></h2>
<div><iframe width="750" height="422" src="https://www.youtube.com/embed/Hc8EtqrlJsE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<h1><a class="header" href="#worth-mentioning" id="worth-mentioning">Worth Mentioning</a></h1>
<details>
<summary>Track your progress with an end-to-end project.</summary>
<span style="display: block; margin-left: 20px;">
<p>Having an end-to-end project that uses the project you are developing helps you discover and prioritize issues.</p>
<p>Initially we began with <a href="https://github.com/amethyst/pong_wasm">Pong</a>, then we became more ambitious:</p>
<details open>
<summary><b>Week 1:</b> Compile</summary>
<span style="display: block; margin-left: 20px;">
<pre><code class="language-bash">$ wasm-pack build -- --features &quot;wasm gl&quot;
# ..
[INFO]: :-) Done in 37.87s
[INFO]: :-) Your wasm pkg is ready to publish at ./pkg.
</code></pre>
</span>
</details>
<details open>
<summary><b>Week 2:</b> Runs 1 frame</summary>
<span style="display: block; margin-left: 20px;">
<p><img src="pong_crash_screenshot.png" alt="Pong Crash" /></p>
</span>
</details>
<details open>
<summary><b>Week 3:</b> It moves</summary>
<span style="display: block; margin-left: 20px;">
<p><img src="pong_move.gif" alt="Pong Moves" /></p>
</span>
</details>
<details open>
<summary><b>Week 4:</b> Audio</summary>
<span style="display: block; margin-left: 20px;">
<p><video controls><source src="2020-04-09_pong_wasm_audio.mp4" /></video></p>
</span>
</details>
</span>
</details>
<details>
<summary>Forget what you know about programming for a moment</summary>
<span style="display: block; margin-left: 20px; font-size: 1.5em;">
<p>In the following sequence <code>canvas.width()</code> is a getter. Where is <code>canvas.set_attribute(&quot;width&quot;, 640)</code> called?</p>
<ol>
<li>A</li>
<li><code>canvas.width()</code> -&gt; 800</li>
<li>B</li>
<li><code>canvas.width()</code> -&gt; 800</li>
<li>C</li>
<li><code>canvas.width()</code> -&gt; 640</li>
<li>D</li>
</ol>
<details>
<summary>Answer</summary>
<span style="display: block; margin-left: 20px;">
<p>B. See <a href="https://github.com/amethyst/amethyst/issues/2247#issuecomment-616800595">amethyst#2247 (comment)</a></p>
<ol>
<li><code>canvas.width()</code> -&gt; 800</li>
<li><code>canvas.set_attribute(&quot;width&quot;, 640);</code></li>
<li><code>canvas.width()</code> -&gt; 800</li>
<li>Do who-knows-what with Gpu Device and contexts</li>
<li><code>canvas.width()</code> -&gt; 640</li>
</ol>
</span>
</details>
</span>
</details>
<details>
<summary>There will be a project report written in the next week</summary>
<span style="display: block; margin-left: 20px;">
<p>This will cover:</p>
<ul>
<li>How the project was managed.</li>
<li>Project implementation timeline.</li>
<li>Links to forks, issues, and PRs that made it back to upstream repositories.</li>
<li>Future work.</li>
</ul>
</span>
</details>
<h1><a class="header" href="#links" id="links">Links</a></h1>
<ul>
<li><a href="https://github.com/azriel91/wasm_it"><code>wasm_it</code> repository</a></li>
<li><a href="https://github.com/amethyst/amethyst"><code>amethyst</code> repository</a></li>
<li><a href="https://github.com/amethyst/pong_wasm"><code>pong_wasm</code> repository</a></li>
<li><a href="https://github.com/azriel91/autexousious"><code>autexousious</code> repository (game)</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="mermaid/mermaid.min.js"></script>
        
        <script type="text/javascript" src="mermaid/mermaid-init.js"></script>
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
